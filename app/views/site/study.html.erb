<h1 class="study-lead">Study: <%= @study.name %> <span class="badge" id="cell-count"> <%= @study.cell_count %> cells</span></h1>
<div class="panel panel-primary">
	<div class="panel-heading">
		<div class="panel-title">
			<h4><%= link_to "Overview <span class='fa fa-chevron-down toggle-glyph'></span>".html_safe, '#overview', 'data-toggle' => 'collapse', class: 'white', id: 'study-overview'  %></h4>
		</div>
	</div>
	<div id="overview" class="panel-collapse collapse in">
		<div class="panel-body">
			<%= @study.description.html_safe %>
		</div>
	</div>
</div>
<div class="panel panel-primary">
	<div class="panel-heading">
		<div class="panel-title">
			<h4><%= link_to "<span class='fa fa-download'></span> Download #{@study.name} Data <span class='fa fa-chevron-right toggle-glyph'></span>".html_safe, '#files', 'data-toggle' => 'collapse', class: 'white', id: 'study-data-files'  %></h4>
		</div>
	</div>
	<div id="files" class="panel-collapse collapse">
		<div class="panel-body">
			<div class="table-responsive">
				<table class="table table-striped table-condensed">
					<thead>
					<tr>
						<th class="col-sm-5">Filename</th>
						<th class="col-sm-6">Description</th>
						<th class="col-sm-1">Download</th>
					</tr>
					</thead>
					<tbody>
					<% @study_files.each do |study_file| %>
						<tr>
							<td><%= study_file.upload_file_name.nil? ? study_file.name : study_file.upload_file_name %> <%= study_file.file_type == 'Cluster' ? "<strong>(#{study_file.name})</strong>".html_safe : nil %></td>
							<td><%= study_file.description %></td>
							<td>
								<% if @study.embargoed?(current_user) %>
									<span class="label label-warning"><i class="fa fa-ban"></i> Not available until <%= @study.embargo.to_s(:long) %></span>
								<% else %>
									<%= render partial: '/layouts/download_link', locals: {study: @study, study_file: study_file} %>
								<% end %>
							</td>
						</tr>
					<% end %>
					</tbody>
				</table>
        <div class="well well-sm">
        <h2 class="text-center"><span class="label label-default"><i class="fa fa-file-archive-o"></i> Primary Data</span></h2>
          <table class="table table-striped tabled-condensed" id="fastq-table">
              <thead>
                <tr>
                  <th class="col-sm-5">Filename</th>
                  <th class="col-sm-6">Description</th>
                  <th class="col-sm-1">Download</th>
                </tr>
              </thead>
              <tbody id="fastq-files-target"></tbody>
          </table>
        </div>
			</div>
		</div>
	</div>
</div>
<% if @study.initialized? %>
	<div class="row">
		<div class="col-md-3" id="search-target">
			<%= render partial: 'search_options' %>
		</div>
		<div class="col-md-9" id="render-target">
			<%= render partial: 'view_options' %>
			<div class="panel panel-default">
				<div class="panel-heading">
					<div class="panel-title">
						<h4><%= link_to "#{@study.name} Clusters <span class='fa fa-chevron-down toggle-glyph'></span>".html_safe, '#plots', 'data-toggle' => 'collapse' %></h4>
					</div>
				</div>
				<div id="plots" class="panel-collapse collapse in">
					<div class="panel-body">
						<div class="col-md-12">
              <div class="row">
                <div class="col-xs-12">
                  <div id="colorscale-picker"></div>
                  <div id="toggle-plots"></div>
                </div>
              </div>
              <div id="cluster-plot"></div>
              <div id="cluster-figure-legend"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script type="text/javascript">

      $('#cluster-plot').data('rendered', false);

      var baseCamera = {
          "up":{"x":0,"y":0,"z":1},
          "center":{"x":0,"y":0,"z":0},
          "eye":{"x":1.25,"y":1.25,"z":1.25}
      };

      function renderScatter() {
          var url = '<%= render_cluster_path(study_name: params[:study_name]) %>';
          var target = $('#cluster-plot')[0];
          var spinner = new Spinner(opts).spin(target);
          $('#cluster-plot').data('spinner', spinner);
          var cluster = $('#cluster').val();
          var annotation = $('#annotation').val();

          $('#cluster-plot').data('rendered', false);
          $.get(url + '?cluster=' + cluster + '&annotation=' + annotation);
      }

      $(document).ready(function() {
          $('#cluster-plot').data('camera', baseCamera);
          renderScatter();
      });

      // listener for cluster nav, specific to study page
      $("#annotation").change(function() {
          var an = $(this).val();
          // keep track for search purposes
          $('#search_annotation').val(an);
          $('#gene_set_annotation').val(an);
          renderScatter();
      });

      $("#cluster").change(function() {
          var newCluster = $(this).val();
          // keep track for search purposes
          $('#search_cluster').val(newCluster);
          $('#gene_set_cluster').val(newCluster);
          // grab currently selected annotation
          var currAnnot = $('#annotation').val();
          // get new annotation options and re-render
          $.get("<%= get_new_annotations_path(study: params[:study])%>?cluster=" + newCluster, function (data) {
              // parse response as a string and see if currently selected annotation exists in new annotations
              if (data.indexOf(currAnnot) >= 0) {
                  $('#annotation').val(currAnnot);
              }
              $(document).ready(function () {
                  // since we now have new annotations, we need to set them in the search form for persistence
                  var an = $('#annotation').val();
                  $('#search_annotation').val(an);
                  $('#gene_set_annotation').val(an);
                  renderScatter();
              })
          });
      });

      $('#fastq-table').dataTable({
          pagingType: 'full',
          order: [[0, 'asc']],
          ajax: "<%= get_fastq_files_path(study: params[:study_name]) %>",
          deferRender: true,
          autoWidth: false
      });

      $('#files').on('shown.bs.collapse', function() {
          var width = $('#fastq-table').parent().width();
          $('#fastq-table').width(width);
      });

	</script>
<% end %>