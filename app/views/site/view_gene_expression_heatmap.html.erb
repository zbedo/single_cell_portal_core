<div class="row">
	<div class="col-md-12">
		<h1 class="study-lead">Gene Expression for <%= render partial: 'gene_name_list' %><%= render partial: 'missing_genes' %></h1>
	</div>
</div>
<div class="row">
	<div class="col-md-3" id="search-target">
		<%= render partial: 'search_options' %>
	</div>
	<div class="col-md-9" id="render-target">
		<%= render partial: 'view_options' %>
		<div class="panel panel-default">
			<div class="panel-heading">
				<div class="panel-title">
					<h4><%= link_to "Expression Heatmap <span class='fa fa-chevron-down toggle-glyph'></span>".html_safe, '#plots', 'data-toggle' => 'collapse' %> <%= render partial: 'show_search_options_button' %></h4>
				</div>
			</div>
			<div id="plots" class="panel-collapse collapse in">
				<div class="panel-body">
					<div class="col-md-12">
						<div id="heatmap-plot"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>


<script type="text/javascript">
    function drawHeatmap() {
        var dataPath = '<%= javascript_safe_url(expression_query_path(study_name: params[:study_name], search: {genes: params[:search][:genes] })) %>';
        var row_centered = $('#row_centered').prop('checked') ? 1 : 0;
        var selectedAnnot = $('#annotation').val();
        var annotName = selectedAnnot.split('--')[0];
        var annotType = selectedAnnot.split('--')[1];
        dataPath += '&row_centered=' + row_centered;
        var cluster = $('#cluster').val();
        $("#search_cluster").val(cluster);
        $('#search_annotation').val(''); // clear value first
        $("#search_annotation").val(selectedAnnot);
        var requestUser = '<%= user_signed_in? ? current_user.id : nil %>';
        dataPath += '&cluster=' + cluster + '&annotation=' + annotName + '&request_user_id=' + requestUser;

        // call get_annotation_url to load new annotation file url if user has switched from cluster- to study-based or vice versa
        $.getJSON("<%= get_annotation_url_path %>?annotation=" + selectedAnnot + "&cluster=" + cluster, function (data) {
            var newAnnotPath = data.url;
            renderMorpheus(dataPath, newAnnotPath, annotName, annotType, '#heatmap-plot', 'both');
        } );
    }

    var requestUser = '<%= user_signed_in? ? current_user.id : nil %>';
    var path = '<%= javascript_safe_url(expression_query_path(study_name: params[:study_name], search: {genes: params[:search][:genes] })) %>&request_user_id=' + requestUser;
    if ( '<%= params[:cluster] %>' != '' ) {
        path += '&cluster=<%= params[:cluster ]%>';
    };

    var annotPath = '<%= @clusters_url %>';
    var selectedAnnotName = '<%= params[:annotation].split('--').first %>';
    var selectedAnnotType = '<%= @selected_annotation[:type] %>';
    renderMorpheus(path, annotPath, selectedAnnotName, selectedAnnotType, '#heatmap-plot', 'both');

    $("#row_centered, #annotation").change(function() {

        if ($(this).attr('id') == 'annotation') {
            var an = $(this).val();
            // keep track for search purposes
            $('#search_annotation').val(an);
            $('#gene_set_annotation').val(an);
        }
        drawHeatmap();
    });
    // when changing cluster, re-render annotation options and call render function
    $("#cluster").change(function(){
        var newCluster = $(this).val();
        // keep track for search purposes
        $('#search_cluster').val(newCluster);
        $('#gene_set_cluster').val(newCluster);
        var currAnnot = $('#annotation').val();
        // get new annotation options and re-render
        $.get("<%= get_new_annotations_path(study: params[:study])%>?cluster=" + newCluster, function (data) {
            // parse response as a string and see if currently selected annotation exists in new annotations
            if (data.indexOf(currAnnot) >= 0) {
                $('#annotation').val(currAnnot);
            }
            $(document).ready(function () {
                // since we now have new annotations, we need to set them in the search form for persistence
                var an = $('#annotation').val();
                $('#search_annotation').val(an);
                $('#gene_set_annotation').val(an);
                drawHeatmap();
            })
        });
    });


</script>